// Test Schema for SQLite - Simplified for Testing
datasource db {
  provider = "sqlite"
  url      = "file:./test.db"
}

generator client {
  provider = "prisma-client-js"
}

// Users
model User {
  id               String    @id @default(cuid())
  email            String    @unique
  password         String
  name             String
  role             String    @default("CLIENT") // SUPERADMIN, CLIENT, AGENT
  isActive         Boolean   @default(true)
  twoFactorSecret  String?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  businesses Business[]
  sessions   Session[]
  employerId String?
  tickets    Ticket[]   @relation("TicketCreator")
}

// Business
model Business {
  id           String   @id @default(cuid())
  userId       String
  name         String
  activityType String   @default("OTHER")
  language     String   @default("ar")
  status       String   @default("TRIAL")
  trialEndsAt  DateTime?
  
  botTone      String @default("friendly")
  primaryColor String @default("#6366F1")
  widgetConfig String?
  
  messageQuota Int    @default(1000)
  messagesUsed Int    @default(0)
  planType     String @default("TRIAL")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user          User           @relation(fields: [userId], references: [id])
  knowledgeBase KnowledgeBase[]
  conversations Conversation[]
  tickets       Ticket[]
  
  @@index([userId])
}

// Tickets
model Ticket {
  id         String   @id @default(cuid())
  businessId String
  creatorId  String
  subject    String
  status     String   @default("OPEN")
  priority   String   @default("MEDIUM")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  creator  User     @relation("TicketCreator", fields: [creatorId], references: [id])
  
  @@index([businessId])
}

// Knowledge Base
model KnowledgeBase {
  id         String   @id @default(cuid())
  businessId String
  type       String
  content    String
  metadata   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
}

// Conversations
model Conversation {
  id         String   @id @default(cuid())
  businessId String
  channel    String   @default("WIDGET")
  externalId String?
  status     String   @default("ACTIVE")
  rating     Int?
  feedback   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  messages Message[]
  
  @@index([businessId])
}

// Messages
model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String
  content        String
  tokensUsed     Int      @default(0)
  wasFromCache   Boolean  @default(false)
  aiModel        String?
  createdAt      DateTime @default(now())
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
}

// Sessions
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
}

// System Logs
model SystemLog {
  id        String   @id @default(cuid())
  level     String
  message   String
  context   String?
  createdAt DateTime @default(now())
  
  @@index([level])
}
