generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String          @id @default(cuid())
  email            String          @unique
  password         String
  name             String?
  fullName         String?
  role             Role            @default(CLIENT)
  isActive         Boolean         @default(true)
  twoFactorSecret  String?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  employerId       String?
  currentBusinessId String?   // Session-persisted context
  roles            Json?      // { businessId: ['admin', 'viewer'] }
  auditLogs        AuditLog[]
  businesses       Business[]
  payments         Payment[]
  sessions         Session[]
  subscriptions    Subscription[]
  tickets          Ticket[]        @relation("TicketCreator")
  ticketMessages   TicketMessage[]
  employer         Business?       @relation("BusinessEmployees", fields: [employerId], references: [id])
  // CRM relations
  assignedLeads    CrmLead[]        @relation("AssignedTo")
  crmLeadNotes     CrmLeadNote[]    @relation("UserCrmNotes")

  @@index([currentBusinessId])
}

model Business {
  id                       String                  @id @default(cuid())
  userId                   String
  name                     String
  activityType             ActivityType
  language                 String                  @default("ar")
  industry                 String?
  status                   BusinessStatus          @default(TRIAL)
  trialEndsAt              DateTime?
  botTone                  String                  @default("friendly")
  primaryColor             String                  @default("#6366F1")
  allowedOrigins           String[]                // Array for multiple domains
  branding                 Json?                   // { logoUrl, primaryColor, customDomain, emailTemplate }
  aiProviderConfig         Json?                   // { type: 'groq', apiKey: '...' } - Tenant-specific
  /// Widget variant selection: STANDARD or ENHANCED
  widgetVariant            WidgetVariant           @default(STANDARD)
  widgetConfig             String?
  messageQuota             Int                     @default(1000)
  messagesUsed             Int                     @default(0)
  planType                 PlanType                @default(TRIAL)
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  crmLeadCollectionEnabled Boolean                 @default(false)
  preChatFormEnabled       Boolean                 @default(false)
  crmFields                Json?                   // { name: true, email: true, phone: true, custom: [] }
  apiKeys                  ApiKey[]
  apiIntegrations          APIIntegration[]
  user                     User                    @relation(fields: [userId], references: [id])
  crmIntegrations          CRMIntegration[]
  conversations            Conversation[]
  customAIModels           CustomAIModel[]
  dashboardConfigs         DashboardConfig[]
  improvementFeedback      ImprovementFeedback[]
  improvementGoals         ImprovementGoal[]
  improvementSuggestions   ImprovementSuggestion[]
  integrations             Integration[]
  knowledgeBase            KnowledgeBase[]
  knowledgeGaps            KnowledgeGap[]
  notifications            Notification[]
  payments                 Payment[]
  subscriptions            Subscription[]
  telegramIntegration      TelegramIntegration?
  tickets                  Ticket[]
  employees                User[]                  @relation("BusinessEmployees")
  whatsAppIntegration      WhatsAppIntegration?
  crmLeads                 CrmLead[]
  visitors                 Visitor[]
  agentHandoffs            AgentHandoff[]
  knowledgeChunks          KnowledgeChunk[]

  @@index([userId])
  @@index([status])
  @@index([planType])
  @@index([createdAt])
  @@index([userId, status])
  @@index([userId, createdAt])
}

model ApiKey {
  id          String    @id @default(cuid())
  businessId  String
  name        String
  key         String    @unique // Hashed
  prefix      String    // First 8 chars for display
  scopes      String[]  // ['read', 'write']
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([key])
}

model Ticket {
  id         String          @id @default(cuid())
  businessId String
  creatorId  String
  subject    String
  status     TicketStatus    @default(OPEN)
  priority   TicketPriority  @default(MEDIUM)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  business   Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  creator    User            @relation("TicketCreator", fields: [creatorId], references: [id])
  messages   TicketMessage[]
}

model TicketMessage {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  message   String
  createdAt DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  businessId String?
  action     String
  details    String?
  ipAddress  String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  
  @@index([businessId])
}

model Payment {
  id            String        @id @default(cuid())
  userId        String
  businessId    String?
  amount        Float
  currency      String        @default("USD")
  status        PaymentStatus @default(PENDING)
  paymentMethod String?
  transactionId String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  business      Business?     @relation(fields: [businessId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id         String             @id @default(cuid())
  userId     String
  businessId String?
  planType   PlanType
  status     SubscriptionStatus @default(ACTIVE)
  startDate  DateTime           @default(now())
  endDate    DateTime?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  business   Business?          @relation(fields: [businessId], references: [id])
  user       User               @relation(fields: [userId], references: [id])
}

model APIIntegration {
  id         String   @id @default(cuid())
  businessId String
  provider   String
  apiKey     String?
  config     String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model CRMIntegration {
  id         String   @id @default(cuid())
  businessId String
  type       String
  config     String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Conversation {
  id             String        @id @default(cuid())
  businessId     String
  visitorId      String?
  platform       String        @default("web")
  channel        String?       @default("widget") // Added channel
  status         String        @default("active")
  externalId     String?       // For WhatsApp/Telegram
  agentId        String?       // Assigned agent
  agentRating    Int?          // Agent quality rating
  metadata       String?       // Added metadata
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  business       Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  messages       Message[]
  agentHandoff   AgentHandoff?
  visitor        Visitor?      @relation(fields: [visitorId], references: [id])

  @@index([businessId])
  @@index([visitorId])
  @@index([externalId])
}

model Message {
  id                String             @id @default(cuid())
  conversationId    String
  sender            String
  content           String
  type              String             @default("text")
  role              String?            // USER or ASSISTANT
  metadata          String?            // Added metadata
  createdAt         DateTime           @default(now())
  conversation      Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sentimentAnalysis SentimentAnalysis?
  languageDetection LanguageDetection?

  @@index([conversationId])
}

model CustomAIModel {
  id          String   @id @default(cuid())
  businessId  String
  name        String
  description String?
  config      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model DashboardConfig {
  id         String   @id @default(cuid())
  businessId String
  layout     String?
  widgets    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model ImprovementFeedback {
  id         String   @id @default(cuid())
  businessId String
  content    String
  rating     Int?
  createdAt  DateTime @default(now())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model ImprovementGoal {
  id          String   @id @default(cuid())
  businessId  String
  description String
  targetDate  DateTime?
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model ImprovementSuggestion {
  id         String   @id @default(cuid())
  businessId String
  content    String
  category   String?
  createdAt  DateTime @default(now())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Integration {
  id         String   @id @default(cuid())
  businessId String
  type       String
  config     String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model KnowledgeBase {
  id         String   @id @default(cuid())
  businessId String
  title      String
  content    String
  tags       String?
  source     String   @default("manual")
  metadata   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  chunks     KnowledgeChunk[]
}

model KnowledgeGap {
  id         String   @id @default(cuid())
  businessId String
  query      String
  frequency  Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Notification {
  id         String   @id @default(cuid())
  businessId String
  type       String
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model TelegramIntegration {
  id          String   @id @default(cuid())
  businessId  String   @unique
  botToken    String
  botUsername String?
  webhookUrl  String?
  chatId      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model WhatsAppIntegration {
  id            String   @id @default(cuid())
  businessId    String   @unique
  phoneNumberId String?
  accessToken   String?
  verifyToken   String?
  appSecret     String?
  webhookUrl    String?
  phoneNumber   String?
  apiKey        String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Visitor {
  id          String   @id @default(cuid())
  businessId  String
  fingerprint String
  name        String?
  email       String?
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  sessions    VisitorSession[]
  conversations Conversation[]
  
  @@unique([businessId, fingerprint])
}

model VisitorSession {
  id          String   @id @default(cuid())
  visitorId   String
  userAgent   String?
  ipAddress   String?
  country     String?
  city        String?
  device      String?
  pageViews   Int      @default(0)
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  visitor     Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)
}

model CrmLead {
  id           String        @id @default(cuid())
  businessId   String
  name         String?
  email        String?
  phone        String?
  status       String        @default("new")
  source       String?
  assignedToId String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assignedTo   User?         @relation("AssignedTo", fields: [assignedToId], references: [id])
  notes        CrmLeadNote[]
}

model CrmLeadNote {
  id        String   @id @default(cuid())
  leadId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  lead      CrmLead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation("UserCrmNotes", fields: [userId], references: [id])
}

enum Role {
  ADMIN
  CLIENT
  EMPLOYEE
}

enum ActivityType {
  ECOMMERCE
  SERVICE
  OTHER
}

enum BusinessStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
}

model SentimentAnalysis {
  id             String   @id @default(cuid())
  messageId      String?  @unique // Added unique constraint for 1:1 relation
  conversationId String?
  sentiment      String
  confidence     Float
  intensity      Float?   // Added to match code
  emotions       String?
  createdAt      DateTime @default(now())
  message        Message? @relation(fields: [messageId], references: [id]) // Added relation

  @@index([messageId])
  @@index([conversationId])
}

model LanguageDetection {
  id             String   @id @default(cuid())
  messageId      String?  @unique // Added unique constraint for 1:1 relation
  conversationId String?
  language       String
  confidence     Float
  dialect        String?
  createdAt      DateTime @default(now())
  message        Message? @relation(fields: [messageId], references: [id]) // Added relation

  @@index([messageId])
  @@index([conversationId])
}

model AgentHandoff {
  id             String        @id @default(cuid())
  conversationId String        @unique
  businessId     String
  requestedBy    String?
  assignedTo     String?
  agentId        String?       // Added to match code
  priority       String        @default("MEDIUM")
  status         String        @default("PENDING")
  reason         String?
  notes          String?
  feedback       String?       // Added to match code
  qualityScore   Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  resolvedAt     DateTime?
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  business       Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
}
model KnowledgeChunk {
  id              String         @id @default(cuid())
  businessId      String
  knowledgeBaseId String?
  content         String
  embedding       String?
  metadata        String?
  createdAt       DateTime       @default(now())
  business        Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  knowledgeBase   KnowledgeBase? @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

enum WidgetVariant {
  STANDARD
  ENHANCED
}

enum PlanType {
  TRIAL
  BASIC
  PRO
  ENTERPRISE
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}
